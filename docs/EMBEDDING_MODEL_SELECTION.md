# 임베딩 모델 선택 가이드

## 📌 왜 모델 비교가 필요한가?

임베딩 모델마다 다음 특성이 다릅니다:
- **검색 성능**: 얼마나 정확하게 찾는가?
- **속도**: 얼마나 빠른가?
- **메모리**: 얼마나 많은 저장공간이 필요한가?
- **품질**: 임베딩의 품질이 어떤가?

### ⚠️ 평가의 한계

**Ground Truth 편향:**
- 본 프로젝트의 GT는 **BGE-M3 검색 결과**를 기반으로 생성됨
- BGE-M3으로 검색 → Top-5 확인 → 정답 선택 → GT 생성
- 결과: **BGE-M3에 유리한 GT** (Recall@5: 87.5% vs 다른 모델: 20.8%)

**의미:**
- BGE-M3의 높은 성능은 일부 GT 편향 효과 포함
- 다른 모델의 낮은 성능이 "나쁜 모델"을 의미하지는 않음
- 다만, **실용적 관점**에서 BGE-M3이 더 유용한 것은 사실

**권장:**
- 모델 선택 시 Recall 수치만 맹신하지 말 것
- 실제 사용 사례로 직접 테스트 권장
- 속도/메모리/품질도 함께 고려

---

## 🔬 평가 도구

### 1️⃣ 빠른 비교 (추천!)

```bash
python scripts/quick_model_compare.py
```

**특징:**
- 2개 모델만 비교 (빠름)
- 50개 샘플로 테스트
- 5분 이내 완료

**비교 대상:**
- `bge-m3`: 현재 사용 중 (1024차원)
- `bge-small`: 빠르고 작은 버전 (384차원)

---

### 2️⃣ 전체 비교

```bash
python scripts/compare_embedding_models.py
```

**특징:**
- 5개 모델 전체 비교
- 100개 샘플로 테스트
- 20-30분 소요

**비교 모델:**
1. `bge-m3`: 다국어, 범용 (1024차원)
2. `bge-small`: 빠름, 작음 (384차원)
3. `bge-base`: 균형 (768차원)
4. `bge-large`: 정확, 느림 (1024차원)
5. `multilingual-e5`: 다국어 (1024차원)

---

## 📊 평가 지표

### 1. 검색 성능 (가장 중요!)

**Recall@K**: Top-K 결과에 정답이 있는 비율
- Recall@1: 1위에 정답
- Recall@3: 3위 안에 정답 (RAG에서 중요!)
- Recall@5: 5위 안에 정답

**MRR (Mean Reciprocal Rank)**: 정답의 평균 역순위
- 1.0: 항상 1위
- 0.5: 평균 2위
- 0.33: 평균 3위

**목표:**
- Recall@3: 70% 이상 (우수)
- Recall@5: 85% 이상 (좋음)
- MRR: 0.5 이상 (양호)

---

### 2. 임베딩 속도

**docs/sec**: 초당 처리 문서 수
- 100+ docs/sec: 빠름 ⚡
- 50-100 docs/sec: 보통 ✓
- <50 docs/sec: 느림 🐌

**전체 코퍼스 (16,000개) 임베딩 시간:**
- 100 docs/sec: ~3분
- 50 docs/sec: ~5분
- 25 docs/sec: ~10분

---

### 3. 메모리 사용량

**전체 코퍼스 기준 (16,000개):**
- 384차원: ~50MB (작음) 💾
- 768차원: ~100MB (보통) 
- 1024차원: ~130MB (큼)

**고려사항:**
- Qdrant 저장소 크기
- 검색 시 메모리 사용
- 서버 용량

---

### 4. 임베딩 품질

**유사도 분포:**
- 평균: 문서 간 평균 유사도
- 표준편차: 구분 능력 (높을수록 좋음)

**좋은 임베딩:**
- 표준편차가 높음 (문서를 잘 구분)
- 평균이 낮음 (무분별한 유사성 없음)

---

## 🎯 모델 선택 기준

### Case 1: 성능 최우선

**추천: bge-large 또는 bge-m3**

```
장점:
✅ 검색 성능 최고
✅ 정확한 검색
✅ 다국어 지원 (m3)

단점:
❌ 느림 (50 docs/sec)
❌ 메모리 많이 사용 (130MB)
```

**적합한 경우:**
- 정확도가 가장 중요
- 서버 자원 충분
- 임베딩 1회만 생성

---

### Case 2: 속도 최우선

**추천: bge-small**

```
장점:
✅ 매우 빠름 (200+ docs/sec)
✅ 메모리 작음 (50MB)
✅ 실시간 임베딩 가능

단점:
❌ 검색 성능 약간 낮음
❌ 복잡한 쿼리 취약
```

**적합한 경우:**
- 빠른 응답 필요
- 실시간 임베딩
- 메모리 제한

---

### Case 3: 균형 (추천!)

**추천: bge-base 또는 bge-m3**

```
장점:
✅ 성능 좋음 (Recall@3 70%+)
✅ 속도 적당 (70-100 docs/sec)
✅ 메모리 적당 (100-130MB)

이유:
• RAG 용도로 충분한 성능
• 실용적인 속도
• 합리적인 메모리
```

**적합한 경우:**
- 대부분의 RAG 시스템 ⭐
- 성능과 효율 균형
- 프로덕션 환경

---

## 📈 실전 예시

### 빠른 비교 결과 예시

```
모델                      속도            메모리          검색
bge-m3 (현재)            68.5 docs/sec   130 MB          100%
bge-small (빠름)         215.3 docs/sec  49 MB           95%

결론:
• bge-small이 3.1배 빠름
• bge-small이 2.7배 작음
• 검색 성능 차이 5%

추천: 성능 우선이면 bge-m3, 속도 우선이면 bge-small
```

---

### 전체 비교 결과 예시

```
모델            총점   검색   속도   메모리  품질
bge-m3         85.2   38.0   22.5   15.8   8.9
bge-base       82.4   36.5   25.3   18.2   8.4
bge-small      78.9   34.2   31.8   20.0   7.9
multilingual   83.1   37.2   20.1   15.9   9.0
bge-large      84.6   39.1   18.5   15.2   9.1

추천:
🥇 종합 1위: bge-m3
⚡ 속도 최고: bge-small
💾 메모리 최고: bge-small
🎯 검색 최고: bge-large
```

---

## 💡 실행 가이드

### 1단계: 빠른 비교

```bash
# 현재 vs 대안 빠른 비교 (5분)
python scripts/quick_model_compare.py
```

**판단:**
- 속도 차이 3배 이상 → bge-small 고려
- 검색 성능 차이 10% 이상 → bge-m3 유지
- 비슷하면 → 전체 비교로 진행

---

### 2단계: 전체 비교 (필요시)

```bash
# 5개 모델 전체 비교 (30분)
python scripts/compare_embedding_models.py
```

**출력:**
- 모델별 상세 지표
- 종합 순위
- 추천 모델

**결과 파일:**
- `data/model_comparison_results.csv`

---

### 3단계: 선택한 모델로 재생성

```bash
# 예: bge-base로 변경
# 1. embed_providers.py 수정
DEFAULTS = {
    'bge': 'BAAI/bge-base-en-v1.5'  # 변경
}

# 2. 임베딩 재생성
python scripts/regenerate_embeddings.py

# 3. Qdrant 업로드
python scripts/upload_to_qdrant.py

# 4. 성능 평가
python scripts/evaluate_retrieval.py
```

---

## ⚠️ 주의사항

### 1. 샘플 크기

- 빠른 비교: 50개 (5분)
- 전체 비교: 100개 (30분)
- 더 정확한 평가: 500개+ (2시간+)

**권장:**
- 처음: 빠른 비교
- 최종 결정: 100개 이상

---

### 2. Ground Truth 문제

현재 평가는 **circular logic** 문제가 있습니다:
- 같은 모델로 검색해서 정답 저장
- 같은 모델로 평가
- → 과대평가 가능

**해결:**
- 수동 검증 (30개 샘플)
- 실제 사용자 테스트
- A/B 테스트

---

### 3. 다국어 vs 영어 전용

**한국어 데이터라면:**
- bge-m3 (다국어) 추천 ⭐
- multilingual-e5 (다국어) 추천
- bge-*-en (영어 전용) 비추천

---

## 🎯 결론

### 현재 추천 (경일대 RAG)

**1순위: bge-m3** ✅
```
이유:
• 다국어 지원 (한국어 우수)
• 검색 성능 우수
• 현재 사용 중 (검증됨)
• 합리적인 속도/메모리
```

**2순위: bge-base**
```
조건: 속도가 중요한 경우
• bge-m3보다 30% 빠름
• 메모리 20% 절약
• 성능 5-10% 낮음
```

**3순위: bge-small**
```
조건: 극단적인 속도 필요
• bge-m3보다 3배 빠름
• 메모리 1/3
• 성능 10-15% 낮음
```

---

## 📊 요약 테이블

| 모델 | 속도 | 메모리 | 성능 | 추천도 |
|------|------|--------|------|--------|
| bge-m3 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| bge-base | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| bge-small | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| bge-large | ⭐⭐ | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| e5-multi | ⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

---

**현재 상태:** bge-m3 사용 중 ✅  
**변경 필요성:** 낮음 (성능 우수, 검증됨)  
**대안 고려:** 속도가 중요하면 bge-base


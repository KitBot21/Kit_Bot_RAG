# 날짜 인식 개선 업데이트

## 📅 문제점

"오늘 분식당 메뉴 뭐야?" 같은 질문에 대해:
- ❌ "오늘"이 날짜로 매칭되지 않음
- ❌ LLM이 현재 날짜/요일 정보 없이 답변
- ❌ 문서에 "11월 4일", "화요일" 등이 있어도 연결 못함

## ✅ 해결 방법

### 1. 프롬프트에 날짜 정보 추가
```python
# rag_demo.py 수정
system_prompt = f"""
**현재 날짜**: {today_info}  # 예: 2025년 11월 04일 (화요일)
- 질문에 "오늘", "이번주" 등의 시간 표현이 있으면 위 날짜를 기준으로 답변하세요
- 요일별 정보가 필요하면 현재 요일을 참고하세요
"""
```

### 2. app.py score→similarity 버그 수정
```python
# 기존 (오류)
'similarity': round(ctx.get('similarity', 0), 3)

# 수정 (정상)
'similarity': round(ctx.get('score', 0), 3)
```

## 📊 검색 품질 확인

### 테스트 결과
| 질문 | Top-1 제목 | 점수 | 비고 |
|------|-----------|------|------|
| "오늘 분식당 메뉴 뭐야" | 오름관2동 | 0.609 | 11/4 포함 문서 |
| "11월 4일 분식당 메뉴" | 오름관2동 | 0.646 | ✅ 직접 매칭 |
| "분식당 메뉴" | 오름관2동 | 0.600 | 일반 검색 |
| "화요일 분식당 일품요리" | **분식당** | **0.668** | ✅ 정확! |

### 발견 사항
- ✅ 분식당 관련 문서: 752개 존재
- ✅ 11월 3일~9일 메뉴 모두 수집됨
- ⚠️ "분식당" 제목의 문서가 순위가 낮음 (3위)
- ✅ "화요일 + 일품요리" 조합은 완벽하게 작동

## 🚀 적용 방법

### 서버 재시작
```bash
# 1. 기존 서버 종료 (터미널에서 Ctrl+C)

# 2. 재시작
cd /home/jhlee/Kit_Bot_RAG
source .venv/bin/activate
python3 app.py
```

### 테스트 질문
```
✅ 오늘 분식당 메뉴 뭐야
✅ 오늘 교직원식당 메뉴
✅ 이번주 화요일 일품요리
✅ 내일 오름관1동 점심 메뉴
```

## 💡 추가 개선 가능 사항

### 1. Query Expansion (향후)
"오늘" → "11월 4일", "화요일" 자동 변환
```python
# 쿼리 전처리
if "오늘" in query:
    query += f" {today.strftime('%m월 %d일')} {today.strftime('%A')}"
```

### 2. 메타데이터 필터링 (향후)
날짜 범위로 필터링
```python
# Qdrant 검색 시 필터 추가
filter={
    "must": [
        {"key": "date", "range": {"gte": "2025-11-03", "lte": "2025-11-09"}}
    ]
}
```

### 3. 제목 가중치 부여 (향후)
"분식당" 제목 문서 우선순위 증가
```python
# 검색 후 재순위화
if "분식당" in query:
    for ctx in contexts:
        if "분식당" in ctx['title']:
            ctx['score'] *= 1.5  # 가중치 1.5배
```

## 📝 변경 파일

1. ✅ `/home/jhlee/Kit_Bot_RAG/rag_demo.py`
   - 날짜 정보 추가
   - 프롬프트 개선

2. ✅ `/home/jhlee/Kit_Bot_RAG/app.py`
   - similarity 키 오류 수정

## 🎯 예상 효과

- ✅ "오늘" 질문에 정확한 날짜 기준 답변
- ✅ 요일 정보 활용 가능
- ✅ "이번주", "내일" 등도 처리 가능
- ✅ LLM이 문서의 날짜 정보와 현재 날짜를 연결

---

**작성자**: GitHub Copilot  
**작성일**: 2025-11-04  
**버전**: 1.0
